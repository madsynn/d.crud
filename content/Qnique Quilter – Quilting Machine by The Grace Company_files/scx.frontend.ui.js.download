;(function(){var W=window,D=document,title=D.title,root=this,prev_scx_ui=root.SCX_UI,$=function(selector){return D.querySelector(selector);};function SCX_UI(opts){var self=this;var default_opts={app_id:'',max_msgs:70,default_mode:'',hide_when_offline:false,show_btn:true,show_prechat:true,show_postchat:true,user:{},is_frontend:true,minimized_before:false};this.opts=default_opts;for(var k in opts){this.opts[k]=opts[k];}this.app=new ChatX(this.opts);this.mode='init';this.btn_mode=null;this.popup_mode=null;this.chat_id=null;this.tmp_chat_id=null;this.chat={};this.chat_msgs={};this.last_msg='';this.ops=null;this.modes_list='_scx-online _scx-offline _scx-prechat _scx-postchat';this.$widget=D.getElementsByClassName('scx-w');this.$btn=D.getElementsByClassName('scx-chat-btn');this.$popup=D.getElementsByClassName('scx-popup-'+this.mode);this.$forms=D.getElementsByClassName('scx-form');this.$attention=D.getElementById('scx-attention');this.$cnv=D.getElementsByClassName('scx-cnv');this.$reply=D.getElementsByClassName('scx-reply');this.$reply_send=D.getElementsByClassName('scx-reply-send');this.$btn_end=D.getElementsByClassName('scx-btn-end-chat');this.$typing=D.getElementsByClassName('scx-typing');this.$sc_btn=D.getElementsByClassName('scx-shortcode-chat-btn');this._ui();this._bind_data_events();firebase.auth().onAuthStateChanged(function(auth){if(auth){if(auth){var user_id=auth.uid,username=self.opts.user.name;self.app.set_user(user_id,username);}}else{self.app.db.login('anonymously',function(err,auth){if(err){self.update_mode('offline');console.error(err);}});}});if(!this.opts.hide_when_offline&&this.opts.show_btn&&this.popup_mode!=='open'){this.btn('init')}}SCX_UI.prototype={_bind_data_events:function(){this.app.on('on-connect',this._on_connect.bind(this));this.app.on('op-update',this._on_op_update.bind(this));this.app.on('chat-join',this._on_join_chat.bind(this));this.app.on('chat-update',this._on_update_chat.bind(this));this.app.on('chat-exit',this._on_leave_chat.bind(this));this.app.on('msg-new',this._on_new_msg.bind(this));this.app.on('msg-remove',this._on_removed_msg.bind(this));this.app.on('chat-action',this._on_action.bind(this));this.app.on('chat-action-response',this._on_action_response.bind(this));},_ui:function(){var self=this,typing=false;var fn_open_popup=function(e){e.preventDefault();if(self.popup_mode==='open'){fn_close_popup(e);return;}self.btn('hide');self.popup('show');var $reply=this.parentNode.querySelector('.scx-reply');if(self.mode==='online'&&$reply){root.setTimeout(function(){$reply.focus();},500);}}
var fn_close_popup=function(e){e.preventDefault();self.popup('hide');self.btn('show');}
var fn_done=function(e){e.preventDefault();self.popup('hide');self.btn('show');if(self.mode==='postchat'){self.update_mode('online');}}
var fn_delay=(function(){var timer=0;return function(callback,ms){root.clearTimeout(timer);timer=root.setTimeout(callback,ms);};})();if(self.$btn){var $btn=null;for(var i=0;i<self.$btn.length;i++){$btn=self.$btn[i];$btn.addEventListener('click',fn_open_popup);}}var $popup_headers=D.querySelectorAll('.scx-popup .scx-header');if($popup_headers){var $header=null;for(var i=0;i<$popup_headers.length;i++){$header=$popup_headers[i];$header.addEventListener('click',fn_close_popup);}}var $btn_close_popup=D.getElementsByClassName('btn-close-popup');if($btn_close_popup){for(var i=0;i<$btn_close_popup.length;i++){$btn_close_popup[i].addEventListener('click',fn_close_popup);}}var $btn_done=D.getElementsByClassName('btn-done');if($btn_done){for(var i=0;i<$btn_done.length;i++){$btn_done[i].addEventListener('click',fn_done);}}if(self.$forms){self._setup_forms();if(self.$btn_end){for(var i=0;i<self.$btn_end.length;i++){self.$btn_end[i].addEventListener('click',function(e){e.preventDefault();var ask=confirm(self.opts._ask_end_chat);if(ask){self.end_chat();}});}}}var fn_send=function(){var $reply=D.querySelector('.scx-reply'),msg=$reply.value.trim();typing=false;self.app.db.typing(null,self.chat_id);if(msg.length>0){$reply.value='';$reply.focus();if(self.chat_id){self.app.db.push_msg(self.chat_id,msg,null);}else{var chat_data={name:self.app.db.username,visitor_id:self.app.user_id};self.app.db.create_chat(chat_data,'private',function(new_chat_id){self.$cnv.id=['scx-cnv-',new_chat_id].join('');self.chat_id=new_chat_id;self.app.db.push_msg(new_chat_id,msg,null);});}}}
var fn_reply=function(e){if(e&&e.keyCode===13&&!e.shiftKey){fn_send();e.preventDefault();}else{if(!typing){switch(e.keyCode){case 17:case 18:case 16:case 20:case 9:case 8:case 224:case 17:case 91:case 93:return true;}self.app.db.typing(true,self.chat_id);typing=true;}fn_delay(function(){self.app.db.typing(null,self.chat_id);typing=false;},1000);return true;}};if(self.$reply){for(var i=0;i<self.$reply.length;i++){self.$reply[i].addEventListener('keydown',fn_reply);}}if(self.$reply_send){for(var i=0;i<self.$reply_send.length;i++){self.$reply_send[i].addEventListener('click',fn_send);}}var $online_popups=D.querySelectorAll('.scx-popup-online');if($online_popups){for(var i=0;i<$online_popups.length;i++){$online_popups[i].addEventListener('click',function(e){self._read();});}}var fn_email_chat=function(e){e.preventDefault();var $form=this.parentNode.querySelector('.scx-form-email'),$f_email=$('.scx-popup-postchat .scx-f-email'),$f_send=$('.scx-popup-postchat .scx-send'),working=false;self.app.add_class($form,'scx-active');if(!self.chat_msgs){self.ntf('error',self.opts._no_msg,'error',self.mode);$f_email.disabled=true;return;}if(self.tmp_user.email){$f_email.value=self.tmp_user.email;}setTimeout(function(){$f_email.focus();},400);$f_send.addEventListener('click',function(btn_e){btn_e.preventDefault();var email=$f_email.value.trim();if(!email||!self.app.is_email(email)){self.app.add_class($f_email,'scx-error');self.app.ntf('error',self.opts._invalid_email,'error',self.mode);return;}if(working)return;working=true;self.app.remove_class($f_email,'scx-error');self.app.hide_ntf('error');self.app.ntf('wait',self.opts._wait,'wait',self.mode);$f_email.disabled=true;self.app.add_class($f_send,'scx-disabled');var msg={},body=[];for(var id in self.chat_msgs){msg=self.chat_msgs[id];if(msg.user_id===self.app.db.user_id){msg.name=self.opts._you;}if(msg.type==='default'){body.push('<p><strong>'+msg.name+':</strong> <span>'+msg.msg+'</span></p>');}}var fd={chat_id:self.tmp_chat_id,name:self.tmp_user.name,email:email,content:body.join('')};self.app.post(self.opts.ajax_url+'?action=chatx_ajax_cb&mode=email_chat',fd,function(r){working=false;if(!r.error){self.app.hide_ntf('wait');self.app.ntf('success',r.msg,'success',self.mode,null,3000);$f_email.disabled=false;self.app.remove_class($f_send,'scx-disabled');self.app.remove_class($form,'scx-active');}else{self.app.ntf('error',r.error,'error',self.mode);}});});};var $btn_email_chat=D.getElementsByClassName('btn-email-chat');if($btn_email_chat){for(var i=0;i<$btn_email_chat.length;i++){$btn_email_chat[i].addEventListener('click',fn_email_chat);}}var fn_vote=function(e){e.preventDefault();var self_btn=this,vote=this.getAttribute('data-vote');self.app.db.set_chat_param(self.tmp_chat_id,'vote',vote,function(){self_btn.parentNode.parentNode.innerHTML='<span class="scx-success">'+self.opts._vote_saved+'</span>';});};var $btn_vote=D.getElementsByClassName('scx-btn-vote');if($btn_vote){for(var i=0;i<$btn_vote.length;i++){$btn_vote[i].addEventListener('click',fn_vote);}}if(self.$sc_btn){for(var i=0;i<self.$sc_btn.length;i++){self.$sc_btn[i].addEventListener('click',fn_open_popup);}}var fn_refresh_ui=function(e){var $popup=D.getElementById('scx-popup-'+self.mode),$popup_header=$popup.querySelector('.scx-header'),$popup_content='',e=D.documentElement,g=D.getElementsByTagName('body')[0],x=W.innerWidth||e.clientWidth||g.clientWidth,y=W.innerHeight||e.clientHeight||g.clientHeight,offset_x=self.opts.offset_x*2,h=0;h=y-offset_x-$popup_header.offsetHeight;switch(self.mode){case'online':reply_h=$popup.querySelector('.scx-reply-box').offsetHeight;links_h=$popup.querySelector('.scx-links').offsetHeight;h=h-(reply_h+links_h);$popup_content=$popup.querySelector('.scx-cnv');$popup_content.style.marginBottom=links_h+reply_h+'px';break;default:$popup_content=$popup.querySelector('.scx-content');}if($popup){if(x<=420){$popup.style.width=(x-offset_x)+'px';if(self.opts.pos_x==='left'){$popup.style.left=(offset_x/2)+'px';}else{$popup.style.right=(offset_x/2)+'px';}}else{$popup.style.width=self.opts.popup_size+'px';if(self.opts.pos_x==='left'){$popup.style.left=self.opts.offset_y+'px';}else{$popup.style.right=self.opts.offset_y+'px';}}}if($popup_content){$popup_content.style.maxHeight=h+'px';}}
W.addEventListener('resize',fn_refresh_ui);},_on_op_update:function(ops){var self=this,btn_title='',can_reply=false;this.ops=ops;if(this.ops){btn_title=self.opts._btn_online;if(!self.popup_mode||(self.popup_mode==='open'&&self.mode!=='offline'&&self.mode!=='postchat')){self.update_mode('online');}else if(self.mode==='offline'){var ntf=self.opts._we_online+' <a id="_scx-btn-go-chat" href="javascript:;">'+self.opts._prechat_btn+' &raquo;</a>';self.app.ntf('op-online',ntf,'success','offline-top');D.getElementById('_scx-btn-go-chat').addEventListener('click',function(e){self.update_mode('online');});}if(self.mode==='online'){if(self.$reply){for(var i=0;i<self.$reply.length;i++){self.$reply[i].disabled=false;}for(var i=0;i<self.$reply_send.length;i++){self.app.remove_class(self.$reply_send[i],'scx-disabled');}}}self.app.hide_ntf('we-offline');can_reply=true;}else{btn_title=self.opts._btn_offline;if(!self.popup_mode||(self.popup_mode==='open'&&self.mode!=='online'&&self.mode!=='postchat')){self.update_mode('offline');}if(self.mode==='online'){if(self.$reply){for(var i=0;i<self.$reply.length;i++){self.$reply[i].disabled=true;}for(var i=0;i<self.$reply_send.length;i++){self.app.add_class(self.$reply_send[i],'scx-disabled');}}}self.app.ntf('we-offline',self.opts._we_offline,'error','online');self.app.hide_ntf('op-online');}if((!self.opts.hide_when_offline||(self.opts.hide_when_offline&&this.ops))&&self.popup_mode!=='open'){self.btn('show');}else{self.btn('hide');}for(var i=0;i<self.$btn.length;i++){self.$btn[i].querySelector('.scx-title').innerHTML=btn_title;}self.reply(can_reply);},_on_connect:function(is_connected){var $w='';if(!is_connected){this.app.ntf('no-conn',this.opts._no_conn,'error',this.mode);for(var i=0;i<this.$widget.length;i++){$w=this.$widget[i];this.app.remove_class($w,'_scx-connecting');this.app.add_class($w,'_scx-disconnect');$w.setAttribute('data-status','disconnect');}}else{this.app.hide_ntf('no-conn');for(var i=0;i<this.$widget.length;i++){$w=this.$widget[i];this.app.remove_class($w,'_scx-connecting');this.app.add_class($w,'_scx-connect');$w.setAttribute('data-status','connect');}}},_on_join_chat:function(chat){this.chat_id=chat.id;this.chat=chat;this.app.hide_ntf('scx-welc-msg');this.update_mode('online');if(this.$cnv){var cnv_id=['scx-cnv-',chat.id].join('');for(var i=0;i<this.$cnv.length;i++){this.$cnv[i].id=cnv_id;}}},_on_update_chat:function(chat){this.chat=chat;if(this.$typing){for(var i=0;i<this.$typing.length;i++){this.$typing[i].innerHTML='';if(chat.typing){for(user_id in chat.typing){if(user_id!==this.app.db.user_id){this.$typing[i].insertAdjacentHTML('beforeend',this.render('typing',chat.typing[user_id]));}}}}}},_on_leave_chat:function(chat_id){this.tmp_chat_id=chat_id;this.tmp_user=this.app.db.user;this.last_msg='';this.chat='';this.chat_id='';if(this.$cnv){for(var i=0;i<this.$cnv;i++){this.$cnv[i].innerHTML='';}}if(this.opts.show_postchat){this.update_mode('postchat');}else{this.update_mode('prechat');}},_on_new_msg:function(chat_id,msg){var user_id=msg.user_id;if(this.app.db.is_op)return;if(!this.app.user||!this.app.user.muted||!this.app.user.muted[user_id]){this.last_msg=msg;this.chat_msgs[msg.id]=msg;var read_msgs=this.chat.read_msgs||{};if(read_msgs[this.app.user_id]<msg.timestamp){msg.unread=true;if(msg.type==='default'&&msg.user_id!==this.app.user_id){this.app.play('new-msg');}else if(msg.type==='auto-ntf'){this.app.play('new-ntf');}}if(!this.popup_mode&&(!this.opts.hide_when_offline||(this.opts.hide_when_offline&&this.ops))){this.popup('show');}this.app.add_msg(chat_id,msg);}},_on_removed_msg:function(chat_id,msg_id){var obj_id=['scx-msg-',msg_id].join('');this.app.remove_obj(obj_id);if(this.last_msg.id===msg_id){this.last_msg='';}},_on_action:function(action){var self=this;switch(action.type){case'invite':self.app.db.response_action(action.id,'accepted',function(){self.app.db.join_chat(action.chat_id);});break;case'end-chat':self.end_chat();break;}},_on_action_response:function(action){if(!action.status)return;},_setup_forms:function(){var self=this,form_name=''
$form='';var fn_offline_on_send=function(fd){if(self.app.db.session&&self.app.db.session.geo){fd['xtra-city']=self.app.db.session.geo.city;fd['xtra-country']=self.app.db.session.geo.country.name;fd['xtra-ip']=self.app.db.session.geo.ip;}fd['xtra-ip_addr']=self.opts.ip;fd['xtra-current-page']=self.opts.user.current_page;self.app.post(self.opts.ajax_url+'?action=chatx_ajax_cb&mode=offline',fd,function(r){if(!r.error){self.app.hide_ntf('error');self.app.hide_ntf('wait');$('.scx-field-question .scx-field').value="";self.app.ntf('sent',r.msg,'success','offline',null,3000);setTimeout(function(){self.popup('hide');self.btn('show');},3000);}else{self.app.ntf('error',r.error,'error','offline');}self._reenable_form('offline');});};var fn_prechat_on_send=function(data){var user_data={};for(var id in data){user_data[id]=data[id];}user_data.visitor_id=self.app.user_id;self.app.db.update_user(self.app.user_id,user_data);self._reenable_form('prechat');self.app.db.create_chat(user_data,'private',function(new_chat_id){if(user_data['question']){self.app.db.push_msg(new_chat_id,user_data['question']);root.setTimeout(function(){self.app.db.push_msg(new_chat_id,self.opts._first_reply,'auto-ntf');},2000);}});};for(var i=0;i<self.$forms.length;i++){$form=self.$forms[i];form_name=$form.getAttribute('data-name');$form.addEventListener('submit',function(e){e.preventDefault();});switch(form_name){case'offline':self._setup_fields($form,fn_offline_on_send);break;case'prechat':self._setup_fields($form,fn_prechat_on_send);break;}}},_setup_fields:function($form,on_send){var self=this,valid_nodes=['INPUT','SELECT','TEXTAREA'],form_name=$form.getAttribute('data-name'),$field={},$send_btn=$form.querySelector('.scx-send-btn'),$last_label='';var fn_check_send_btn=function(){var activate=true;for(var i=0;i<$form.elements.length;i++){if($form[i].hasAttribute('required')&&!self.app.has_class($form[i],'scx-valid')){activate=false;}}self.app.remove_class($send_btn,'scx-disabled');if(!activate){self.app.add_class($send_btn,'scx-disabled');}};$send_btn.addEventListener('click',function(e){e.preventDefault();fn_check_send_btn();if(self.form_working)return;self.form_working=true;var data=self._get_form();on_send(data);});var fn_focus=function(e){var $label=this.previousElementSibling;if($last_label){self.app.remove_class($last_label,'_scx-show');}if($label){self.app.add_class($label,'_scx-show');}};var fn_blur=function(e){$last_label=this.previousElementSibling;};var fn_check_form=function(e){e.preventDefault();if(!self.app.has_class($send_btn,'scx-disabled')&&$field.nodeName!=='TEXTAREA'&&e&&e.keyCode===13&&!e.shiftKey){$send_btn.click();}else{self._validate(e.target);fn_check_send_btn();return true;}};for(var i=0;i<$form.elements.length;i++){if(this.app.in_array($form[i].nodeName,valid_nodes)){$field=$form[i];$field.onfocus=fn_focus;$field.onblur=fn_blur;$field.addEventListener('keyup',fn_check_form);$field.addEventListener('change',fn_check_form);}}self.app.add_class($send_btn,'scx-disabled');},_get_form:function(){var form_name=['.scx-popup-',this.mode,' .scx-form'].join(''),$form=D.querySelector(form_name),valid_nodes=['INPUT','SELECT','TEXTAREA'],form_data={},$field='';if(!$form){return;}$fields=$form.elements;$send_btn=$form.querySelector('.scx-send-btn');this.app.add_class($send_btn,'scx-disabled');this.app.ntf('wait',this.opts._wait+'...','wait',this.mode);for(var id in $fields){$field=$fields[id];if($field.value&&this.app.in_array($field.nodeName,valid_nodes)){$field.setAttribute('disabled','disabled');form_data[$field.name]=$field.value;}}var name_field=form_data['name'],email_field=form_data['email'];if(!name_field&&email_field){form_data['name']=email_field.substring(0,email_field.indexOf('@'));}this.app.db.user.name=form_data['name'];this.app.db.username=form_data['name'];return form_data;},_validate:function($el){var val='',is_req=$el.hasAttribute('required'),type=$el.getAttribute('type');if(type==='file'){val=$el.files[0];}else{val=$el.value.trim();}this.app.remove_class($el,'scx-error scx-valid');if(is_req){if(val===''){this.app.add_class($el,'scx-error');this.app.ntf('error',this.opts._req_field,'error',this.mode);return;}else if(type==='email'&&!this.app.is_email(val)){this.app.add_class($el,'scx-error');this.app.ntf('error',this.opts._invalid_email,'error',this.mode);return;}this.app.add_class($el,'scx-valid');this.app.hide_ntf('error');}},_reenable_form:function(mode){var form_name=['.scx-popup-',mode,' .scx-form'].join(''),$form=D.querySelector(form_name),btn_name=['.scx-send-',mode].join('');this.app.remove_class(D.querySelector(btn_name),'scx-disabled');if($form){var fields=$form.elements;for(var id in fields){fields[id].disabled=false;}}},_read:function(){var self=this;if(this.chat_id){if(this.last_msg){this.app.db.read(this.chat_id,this.last_msg.timestamp);}setTimeout(function(){if(self.$cnv){var $new_msgs=D.querySelectorAll('.scx-cnv .scx-new');for(var i=0;i<$new_msgs.length;i++){self.app.remove_class($new_msgs[i],'scx-new');}}},0);}}};SCX_UI.noConflict=function noConflict(){root.SCX_UI=prev_scx_ui;return SCX_UI;};root.SCX_UI=SCX_UI;SCX_UI.prototype.update_mode=function(mode){var self=this,last_popup=['scx-popup-',self.mode].join('');if(mode==='online'&&!self.chat_id&&self.opts.show_prechat){mode='prechat';}var current_popup=['scx-popup-',mode].join('');if(last_popup!==current_popup){self.app.remove_class(D.getElementById(last_popup),'_scx-open scx-active');}if(self.$btn){for(var i=0;i<self.$btn.length;i++){self.app.remove_class(self.$btn[i],'_scx-init');}}self.mode=mode;self.$popup=D.getElementsByClassName(current_popup);if(self.popup_mode==='open'){self.popup('show');}for(var i=0;i<self.$widget.length;i++){$w=self.$widget[i];self.app.remove_class($w,self.modes_list);self.app.add_class($w,'_scx-connect');$w.setAttribute('data-status','connect');}if(self.mode==='online'&&!self.chat_id){self.app.ntf('scx-welc-msg',self.opts._welcome_msg,'info',self.mode);}};SCX_UI.prototype.btn=function(action){var self=this,$btn='';if(self.$btn){for(var i=0;i<self.$btn.length;i++){$btn=self.$btn[i];switch(action){case'init':self.app.add_class($btn,'scx-active _scx-init');self.btn_mode='init';break;case'show':if(!self.opts.show_btn)return;self.app.add_class($btn,'_scx-open scx-active');if(self.mode==='init'){self.app.add_class($btn,'_scx-init');}self.btn_mode='open';break;case'show-with-popup':self.app.add_class($btn,'scx-active');self.btn_mode='open';break;case'toggle':if(self.btn_mode==='open'){self.btn('hide');}else{self.btn('show');}break;case'hide':self.app.remove_class($btn,'scx-active');self.btn_mode=null;break;}}}};SCX_UI.prototype.popup=function(action){var self=this,$popup='';if(self.$popup){for(var i=0;i<self.$popup.length;i++){$popup=self.$popup[i];switch(action){case'show':self.popup_mode='open';self.btn('hide');self.app.add_class($popup,'scx-active _scx-open');var $first_field=(this.mode==='online')?$('.scx-reply'):$popup.querySelector('.scx-field');if($first_field){setTimeout(function(){$first_field.focus();},500);}self.app.db.set_param('popup','open');break;case'hide':self.popup_mode=null;self.app.remove_class($popup,'scx-active _scx-open');self.app.db.set_param('popup',null);break;case'toggle':if(self.popup_mode==='open'){self.popup('hide-with-btn');}else{self.popup('show');}break;case'hide-with-btn':self.popup_mode=null;self.app.remove_class($popup,'scx-active _scx-open');self.app.db.set_param('popup',null);break;}self.refresh_ui();}}};SCX_UI.prototype.reply=function(can_reply){var self=this,$reply='';if(self.$reply){for(var i=0;i<self.$reply.length;i++){$reply=self.$reply[i];if(can_reply){$reply.disabled=false;$reply.focus();self.refresh_ui();self._read();}else{$reply.disabled=true;for(var i=0;i<self.$reply_send.length;i++){self.app.add_class(self.$reply_send[i],'scx-disabled');}}}}};SCX_UI.prototype.refresh_ui=function(){var e=W.document.createEvent('UIEvents');e.initUIEvent('resize',true,false,W,0);W.dispatchEvent(e);if(this.$cnv){for(var i=0;i<this.$cnv.length;i++){this.$cnv[i].scrollTop=10000}}};SCX_UI.prototype.end_chat=function(){if(this.chat_id){var msg=this.opts._user_left_chat.replace('%s',this.app.db.username);this.app.db.push_msg(this.chat_id,msg,'auto-ntf');this.app.db.leave_chat(this.chat_id);}};SCX_UI.prototype.render=function(template,p){var arr=[];switch(template){case'typing':var msg=this.opts._user_typing.replace('%s',p.name);arr=['<span class="scx-user-typing-',p.id,'"><i class="scx-ico scx-ico-pencil"></i>',msg,'...</span>'];break;}return arr.join('');};})();